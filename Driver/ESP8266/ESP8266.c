#include "gd32f4xx.h"
#include "bsp_usart1.h"
#include "esp8266.h"
#include "systick.h"
#include <string.h>
#include <stdio.h>

#define  ESP8266_BUF         Usart1RecBuf 
#define  ESP8266_CNT         RxCounter
#define  STM32_RX1BUFF_SIZE  USART1_RXBUFF_SIZE

unsigned short esp8266_cntPre = 0;

//==========================================================
//	?????????	ESP8266_Clear
//
//	?????????	??????
//
//	????????	??
//
//	?????????	??
//
//	?????	
//==========================================================
void ESP8266_Clear(void)
{
	memset(ESP8266_BUF, 0, sizeof(ESP8266_BUF));
	ESP8266_CNT = 0;
}

//==========================================================
//	?????????	ESP8266_WaitRecive
//
//	?????????	??????????
//
//	????????	??
//
//	?????????	REV_OK-???????		REV_WAIT-??????¦Ä???
//
//	?????		??????¨¹???????????
//==========================================================
_Bool ESP8266_WaitRecive(void)
{
	if(ESP8266_CNT == 0) 							//???????????0 ???????§Õ???????????§µ??????????????????????
		return REV_WAIT;
		
	if(ESP8266_CNT == esp8266_cntPre)				//???????¦Å????????????????????????
	{
		ESP8266_CNT = 0;							//??0???????
			
		return REV_OK;								//????????????
	}
		
	esp8266_cntPre = ESP8266_CNT;					//??????
	
	return REV_WAIT;								//???????¦Ä?????
}

//==========================================================
//	?????????	ESP8266_SendCmd
//
//	?????????	????????
//
//	????????	cmd??????
//				res???????????????
//
//	?????????	0-???	1-???
//
//	?????		
//==========================================================
_Bool ESP8266_SendCmd(char *cmd, char *res, uint16_t time)
{	
  uart1_send((unsigned char *)cmd,strlen((const char *)cmd));
	
	while(time--)
	{
		if(ESP8266_WaitRecive() == REV_OK)							//??????????
		{
			if(strstr((const char *)ESP8266_BUF, res) != NULL)		//??????????????
			{
				ESP8266_Clear();									//??????
				
				return 0;
			}
		}
		
		delay_1ms(1);
	}
	
	return 1;

}

//==========================================================
//	?????????	ESP8266_SendData
//
//	?????????	????????
//
//	????????	data??????
//				len??????
//
//	?????????	??
//
//	?????		
//==========================================================
void ESP8266_SendData(unsigned char *data, unsigned short len)
{

	char cmdBuf[32];
	
	ESP8266_Clear();								//?????????
	sprintf(cmdBuf, "AT+CIPSEND=0,%d\r\n", len);		//????????
	if(!ESP8266_SendCmd(cmdBuf, ">", 200))				//?????>??????????????
	{
			uart1_send(data , len);         //?????õô????????????
	}
}

//==========================================================
//	?????????	ESP8266_GetIPD
//
//	?????????	??????????????
//
//	????????	????????(????10ms)
//
//	?????????	?????????????
//
//	?????		????????õô????????????????????
//				??ESP8266????????	"+IPD,x:yyy"	x????????????yyy??????????
//==========================================================
 unsigned char *ESP8266_GetIPD(unsigned short timeOut)
 {
 	char *ptrIPD = NULL;

 	do
 	{
 		if(ESP8266_WaitRecive() == REV_OK)								//??????????
 		{
 			ptrIPD = strstr((char *)ESP8266_BUF, "IPD,");				//??????IPD???
 			if(ptrIPD == NULL)											//???????????????IPD?????????????????????????????Ú…?????
 			{
 				//printf("\"IPD\" not found\r\n");
 			}
 			else
 			{
 				ptrIPD = strchr(ptrIPD, ':');							//???':'
 				if(ptrIPD != NULL)
 				{
 					ptrIPD++;
 					return (unsigned char *)(ptrIPD);
 				}
 				else
 					return NULL;
			
 			}
 		}
 		delay_1ms(5);													//??????
 	} while(timeOut--);

 	return NULL;														//?????¦Ä?????????????
 }

// ESP8266 ??????????????
// ???Öü??????????? RX_Buffer??????? RX_MAX_LENGTH

// ?????????????????¦Ä?????????? NULL
// unsigned char* ESP8266_GetIPD(uint16_t timeout_ms)
// {
//     static unsigned char ipd_buf[RX1_MAX_LENGTH] = {0};
//     uint16_t len = 0;
//     uint32_t tickstart = get_tick(); // ?????????????tick?????

//     while ((get_tick() - tickstart) < timeout_ms)
//     {
//         // ??øŒ???????????
//         if (RX1_Compelete)
//         {
//             RX1_Compelete = 0;
//             // ???? Usart1RecBuf ????????1?????????
//             memcpy(ipd_buf, Usart1RecBuf, RxCounter);
//             ipd_buf[RxCounter] = 0; // ??¦Â??0
//             len = RxCounter;
//             RxCounter = 0;
//             return ipd_buf;
//         }
//     }
//     return NULL;
// }
//==========================================================
//	?????????	ESP8266_Init
//
//	?????????	?????ESP8266
//
//	????????	??
//
//	?????????	??
//
//	?????		
//==========================================================
void ESP8266_Init(void)
{
	
	usart1_init();
	ESP8266_Clear();
	while(ESP8266_SendCmd("AT\r\n\r", "OK", 200))         //????
	delay_1ms(500);
	
	while(ESP8266_SendCmd("AT+CWMODE=2\r\n", "OK", 200))  //??????????WIFI?????
	delay_1ms(500);
	
	while(ESP8266_SendCmd("AT+CWSAP=\"ESP8266_WIFI\",\"12345678\",5,3\r\n", "OK", 200)) //???????????:ESP8266_WIFI,????:12345678
	delay_1ms(500);
	
	while(ESP8266_SendCmd("AT+CIPMUX=1\r\n", "OK", 200))  //??????????????????????????????
	delay_1ms(500);
	
	while(ESP8266_SendCmd("AT+CIPSERVER=1,8080\r\n", "OK", 200))  //??????????
	delay_1ms(500);
}

void ESP8266_ReceiveData(void) {
    if (strstr((char *)ESP8266_BUF, "E") != NULL) {
        // Handle the reception of character 'A'
        // Set a flag or call a control function
        ESP8266_Clear();
    }
}

